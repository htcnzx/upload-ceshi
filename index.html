<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初中学生报名上传系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <div class="max-w-3xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- 页面标题 -->
        <header class="text-center my-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">2024年初中学生活动报名</h1>
            <p class="text-gray-600">报名信息与文件上传系统</p>
        </header>

        <!-- 报名表单和文件上传区域 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 transform transition-all duration-300 hover:shadow-xl">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">报名信息</h2>
            
            <form id="studentForm" class="space-y-6">
                <!-- 必要信息 -->
                <div class="space-y-5">
                    <div>
                        <label class="block text-gray-700 mb-1" for="fullName">姓名 <span class="text-red-500">*</span></label>
                        <input type="text" id="fullName" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300"
                            placeholder="请输入您的姓名">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-1" for="studentId">学号 <span class="text-red-500">*</span></label>
                        <input type="text" id="studentId" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300"
                            placeholder="请输入您的学号">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-1" for="grade">年级 <span class="text-red-500">*</span></label>
                        <select id="grade" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300">
                            <option value="">请选择年级</option>
                            <option value="初一">初一</option>
                            <option value="初二">初二</option>
                            <option value="初三">初三</option>
                            <option value="初四">初四</option>
                        </select>
                    </div>
                </div>
                
                <!-- 可选文件上传 -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-file-text-o text-blue-500 mr-2"></i>文件上传（可选）
                    </h3>
                    
                    <div id="dropArea" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer transition-colors duration-300 hover:border-blue-500 hover:bg-blue-50">
                        <i class="fa fa-cloud-upload text-4xl text-blue-400 mb-3"></i>
                        <p class="text-gray-600 mb-2">拖放文件到此处，或</p>
                        <label class="inline-block bg-blue-500 text-white py-2 px-6 rounded-md cursor-pointer hover:bg-blue-600 transition duration-300">
                            <i class="fa fa-file-o mr-2"></i>选择文件
                            <input type="file" id="fileInput" class="hidden" multiple>
                        </label>
                        <p id="fileInfo" class="mt-4 text-gray-500 text-sm hidden"></p>
                    </div>
                </div>
                
                <!-- 提交按钮 -->
                <div class="pt-2">
                    <button type="submit" id="submitBtn"
                        class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center justify-center">
                        <i class="fa fa-check mr-2"></i> 提交报名
                    </button>
                </div>
            </form>
        </div>

        <!-- 提交状态和结果 -->
        <div id="statusContainer" class="hidden bg-white rounded-xl shadow-md p-6 mb-6">
            <div id="loadingState" class="text-center py-6 hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
                <p class="text-gray-700">正在提交报名信息，请稍候...</p>
            </div>
            
            <div id="successState" class="text-center py-6 hidden">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 mb-4">
                    <i class="fa fa-check text-2xl text-green-500"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">报名成功！</h3>
                <p class="text-gray-600 mb-4">感谢您的报名，信息已成功提交</p>
                <div id="registrationNumber" class="text-gray-500 text-sm"></div>
            </div>
            
            <div id="errorState" class="text-center py-6 hidden">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 mb-4">
                    <i class="fa fa-times text-2xl text-red-500"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">提交失败</h3>
                <p id="errorMessage" class="text-gray-600 mb-4">请稍后重试</p>
                <button id="retryBtn"
                    class="bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600 transition duration-300">
                    重试
                </button>
            </div>
        </div>

        <!-- 活动说明 -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-info-circle text-blue-500 mr-2"></i>活动说明
            </h2>
            <div class="text-gray-700 space-y-2 text-sm">
                <p>1. 请准确填写个人信息，学号需与学校登记一致</p>
                <p>2. 文件上传为可选项目，如需提交作品或相关材料可在此上传</p>
                <p>3. 提交成功后将生成报名编号，请妥善保存</p>
                <p>4. 如有疑问，请联系活动组织老师</p>
            </div>
        </div>
    </div>

    <script>
        // 配置信息 - 请设置你的GitHub信息
        const config = {
            owner: 'htcnzx',       // 替换为你的GitHub用户名
            repo: 'upload-ceshi',             // 替换为你的仓库名称
            dataPath: 'registrations/students.json',  // 存储报名数据的文件路径
            uploadPath: 'uploads/',                   // 存储上传文件的路径
            token: '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'       // 替换为你的GitHub访问令牌（需要repo权限）
        };

        // 修复btoa编码问题的兼容函数
        function btoaUnicode(str) {
            // 先将字符串转换为UTF-8编码
            return btoa(unescape(encodeURIComponent(str)));
        }

        // DOM元素
        const studentForm = document.getElementById('studentForm');
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const statusContainer = document.getElementById('statusContainer');
        const loadingState = document.getElementById('loadingState');
        const successState = document.getElementById('successState');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const registrationNumber = document.getElementById('registrationNumber');
        const submitBtn = document.getElementById('submitBtn');
        const retryBtn = document.getElementById('retryBtn');
        
        // 存储选择的文件
        let selectedFiles = [];

        // 拖放事件处理
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('border-blue-500', 'bg-blue-50');
        }

        function unhighlight() {
            dropArea.classList.remove('border-blue-500', 'bg-blue-50');
        }

        // 处理文件拖放
        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // 处理文件选择
        fileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });

        // 点击上传区域触发文件选择
        dropArea.addEventListener('click', function(e) {
            if (!e.target.closest('label')) {
                fileInput.click();
            }
        });

        // 处理选择的文件
        function handleFiles(files) {
            if (files.length === 0) return;
            
            selectedFiles = Array.from(files);
            
            // 显示选中的文件信息
            let fileListHtml = '';
            if (selectedFiles.length === 1) {
                fileListHtml = `已选择: ${selectedFiles[0].name} (${formatFileSize(selectedFiles[0].size)})`;
            } else {
                fileListHtml = `已选择 ${selectedFiles.length} 个文件`;
            }
            
            fileInfo.textContent = fileListHtml;
            fileInfo.classList.remove('hidden');
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 表单提交事件
        studentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitForm();
        });

        // 重试按钮事件
        retryBtn.addEventListener('click', submitForm);

        // 提交表单数据
        async function submitForm() {
            // 显示加载状态
            statusContainer.classList.remove('hidden');
            loadingState.classList.remove('hidden');
            successState.classList.add('hidden');
            errorState.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 提交中...';

            try {
                // 收集表单数据
                const formData = {
                    fullName: document.getElementById('fullName').value.trim(),
                    studentId: document.getElementById('studentId').value.trim(),
                    grade: document.getElementById('grade').value,
                    registrationTime: new Date().toISOString(),
                    registrationId: generateRegistrationId()
                };

                // 验证表单数据
                if (!formData.fullName || !formData.studentId || !formData.grade) {
                    throw new Error('请填写完整的报名信息');
                }

                // 上传文件（如果有）
                const uploadedFiles = [];
                if (selectedFiles.length > 0) {
                    // 创建以报名ID命名的文件夹
                    const fileDir = `${config.uploadPath}${formData.registrationId}/`;
                    
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        const fileUrl = await uploadFile(file, fileDir);
                        uploadedFiles.push({
                            name: file.name,
                            size: file.size,
                            path: fileUrl
                        });
                    }
                }

                // 添加上传文件信息
                formData.files = uploadedFiles;

                // 保存报名信息到GitHub
                await saveRegistrationData(formData);

                // 显示成功状态
                loadingState.classList.add('hidden');
                successState.classList.remove('hidden');
                registrationNumber.textContent = `报名编号: ${formData.registrationId}`;
                
                // 重置表单
                studentForm.reset();
                selectedFiles = [];
                fileInfo.classList.add('hidden');

            } catch (error) {
                // 显示错误状态
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                errorMessage.textContent = error.message || '提交过程中出现错误，请重试';
                console.error('提交失败:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-check mr-2"></i> 提交报名';
            }
        }

        // 生成唯一报名ID
        function generateRegistrationId() {
            const timestamp = new Date().getTime();
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `REG-${timestamp}-${random}`;
        }

        // 上传文件到GitHub
        async function uploadFile(file, directory) {
            return new Promise(async (resolve, reject) => {
                try {
                    // 读取文件内容 - 使用ArrayBuffer处理二进制文件
                    const arrayBuffer = await readFileAsArrayBuffer(file);
                    // 转换ArrayBuffer为Base64
                    const base64Content = arrayBufferToBase64(arrayBuffer);

                    // 准备文件路径
                    let path = directory;
                    if (path && !path.endsWith('/')) {
                        path += '/';
                    }
                    const fullPath = path + file.name;

                    // 检查文件是否已存在
                    let sha = null;
                    const checkResponse = await fetch(
                        `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${fullPath}`,
                        {
                            headers: {
                                'Authorization': `token ${config.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    if (checkResponse.ok) {
                        const existingFile = await checkResponse.json();
                        sha = existingFile.sha; // 如果文件存在，获取其SHA用于更新
                    }

                    // 上传文件到GitHub
                    const response = await fetch(
                        `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${fullPath}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${config.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `Upload file for registration: ${file.name}`,
                                content: base64Content,
                                sha: sha // 如果文件存在，需要提供SHA
                            })
                        }
                    );

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `文件上传失败: ${response.status}`);
                    }

                    const result = await response.json();
                    resolve(result.content.path);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // 读取文件为ArrayBuffer（处理二进制文件的正确方式）
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    resolve(event.target.result);
                };
                
                reader.onerror = (error) => {
                    reject(error);
                };
                
                // 读取文件为ArrayBuffer
                reader.readAsArrayBuffer(file);
            });
        }

        // 将ArrayBuffer转换为Base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            
            return btoa(binary);
        }

        // 保存报名数据到GitHub
        async function saveRegistrationData(data) {
            try {
                // 获取现有数据
                const response = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.dataPath}`, {
                    headers: {
                        Authorization: `token ${config.token}`,
                        Accept: 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = null;
                let existingData = [];
                
                // 如果文件存在，获取现有内容和sha值
                if (response.ok) {
                    const fileData = await response.json();
                    sha = fileData.sha;
                    // 解码base64内容
                    existingData = JSON.parse(atob(fileData.content));
                    if (!Array.isArray(existingData)) {
                        existingData = [];
                    }
                }
                
                // 添加新数据
                existingData.push(data);
                
                // 准备提交的数据，使用兼容的编码方式
                const content = btoaUnicode(JSON.stringify(existingData, null, 2));
                
                // 提交到GitHub
                const updateResponse = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.dataPath}`, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${config.token}`,
                        Accept: 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Add new registration: ${data.registrationId}`,
                        content: content,
                        sha: sha // 仅当文件已存在时需要
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.message || `保存报名信息失败: ${updateResponse.status}`);
                }
                
                return true;
            } catch (error) {
                console.error('保存数据失败:', error);
                throw error;
            }
        }
    </script>
</body>
</html>
    
